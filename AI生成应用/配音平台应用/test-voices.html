<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音选择测试工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#6B7280',
                        success: '#10B981',
                        warning: '#F59E0B',
                        error: '#EF4444',
                        info: '#3B82F6',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-soft p-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                <i class="fa fa-microphone text-primary mr-2"></i>语音选择测试工具
            </h1>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">浏览器语音合成支持检测</h2>
                <div id="supportStatus" class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                    <p class="text-gray-600">正在检测浏览器支持...</p>
                </div>
            </div>
            
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">可用语音列表</h2>
                    <button id="refreshBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all-300 flex items-center">
                        <i class="fa fa-refresh mr-2"></i>刷新语音列表
                    </button>
                </div>
                
                <div class="relative">
                    <select id="voiceSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-gray-700 bg-white">
                        <option value="">正在加载可用语音...</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <i class="fa fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
                
                <div id="voiceCount" class="mt-2 text-sm text-gray-500">
                    检测到 0 个可用语音
                </div>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">语音测试</h2>
                <div class="space-y-4">
                    <div>
                        <label for="testText" class="block text-sm font-medium text-gray-700 mb-1">测试文本</label>
                        <input type="text" id="testText" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-gray-700" value="你好，这是一段测试语音。" placeholder="请输入测试文本">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="rateSlider" class="block text-sm font-medium text-gray-700 mb-1">语速</label>
                            <div class="flex items-center space-x-3">
                                <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1" class="flex-1">
                                <span id="rateValue" class="text-sm font-medium text-gray-700 w-8 text-center">1</span>
                            </div>
                        </div>
                        
                        <div>
                            <label for="pitchSlider" class="block text-sm font-medium text-gray-700 mb-1">音调</label>
                            <div class="flex items-center space-x-3">
                                <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1" class="flex-1">
                                <span id="pitchValue" class="text-sm font-medium text-gray-700 w-8 text-center">1</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="testBtn" class="w-full py-3 bg-success text-white rounded-lg hover:bg-success/90 transition-all-300 flex items-center justify-center font-medium">
                        <i class="fa fa-play mr-2"></i>播放测试语音
                    </button>
                </div>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">语音详细信息</h2>
                <div id="voiceDetails" class="p-4 rounded-lg bg-gray-50 border border-gray-200 h-32 overflow-y-auto">
                    <p class="text-gray-500 italic">请从上方选择一个语音以查看详细信息</p>
                </div>
            </div>
            
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">调试信息</h2>
                <div id="debugInfo" class="p-4 rounded-lg bg-gray-900 text-gray-200 h-40 overflow-y-auto font-mono text-sm">
                    <p class="text-gray-400">调试信息将在这里显示...</p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-8 text-sm text-gray-500">
            <p>如果您在使用配音工具时遇到语音选择问题，请查看此测试工具的结果。</p>
            <p class="mt-1">如果这里也无法显示语音，请检查浏览器权限设置或尝试更新浏览器。</p>
        </div>
    </div>

    <script>
        // 全局变量
        let synth = window.speechSynthesis;
        let voices = [];
        let isSpeaking = false;
        
        // DOM 元素
        const supportStatus = document.getElementById('supportStatus');
        const voiceSelect = document.getElementById('voiceSelect');
        const voiceCount = document.getElementById('voiceCount');
        const refreshBtn = document.getElementById('refreshBtn');
        const testBtn = document.getElementById('testBtn');
        const testText = document.getElementById('testText');
        const rateSlider = document.getElementById('rateSlider');
        const rateValue = document.getElementById('rateValue');
        const pitchSlider = document.getElementById('pitchSlider');
        const pitchValue = document.getElementById('pitchValue');
        const voiceDetails = document.getElementById('voiceDetails');
        const debugInfo = document.getElementById('debugInfo');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('初始化语音测试工具...');
            
            // 检查浏览器支持
            checkBrowserSupport();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 开始加载语音
            startVoiceLoading();
        });
        
        // 检查浏览器支持
        function checkBrowserSupport() {
            log('检查浏览器语音合成支持...');
            
            if (!synth) {
                supportStatus.innerHTML = `
                    <div class="flex items-center text-error">
                        <i class="fa fa-times-circle mr-2 text-xl"></i>
                        <span>❌ 您的浏览器不支持语音合成功能</span>
                    </div>
                    <p class="mt-2 text-gray-600">请使用 Chrome、Edge、Safari 等现代浏览器。</p>
                `;
                log('浏览器不支持语音合成');
                return false;
            }
            
            supportStatus.innerHTML = `
                <div class="flex items-center text-success">
                    <i class="fa fa-check-circle mr-2 text-xl"></i>
                    <span>✅ 浏览器支持语音合成功能</span>
                </div>
                <p class="mt-2 text-gray-600">正在加载可用语音...</p>
            `;
            log('浏览器支持语音合成');
            return true;
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 刷新按钮
            refreshBtn.addEventListener('click', () => {
                log('手动刷新语音列表');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>刷新中...';
                
                // 取消任何正在进行的语音合成
                synth.cancel();
                
                // 延迟一下再重新加载，确保取消生效
                setTimeout(() => {
                    startVoiceLoading();
                    
                    setTimeout(() => {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>刷新语音列表';
                    }, 1000);
                }, 100);
            });
            
            // 语音选择变化
            voiceSelect.addEventListener('change', () => {
                const selectedVoice = voiceSelect.value;
                if (selectedVoice) {
                    const voice = voices.find(v => v.name === selectedVoice);
                    if (voice) {
                        displayVoiceDetails(voice);
                        log(`选择了语音: ${voice.name}`);
                    }
                } else {
                    voiceDetails.innerHTML = '<p class="text-gray-500 italic">请从上方选择一个语音以查看详细信息</p>';
                }
            });
            
            // 测试按钮
            testBtn.addEventListener('click', () => {
                testSelectedVoice();
            });
            
            // 语速滑块
            rateSlider.addEventListener('input', () => {
                rateValue.textContent = rateSlider.value;
            });
            
            // 音调滑块
            pitchSlider.addEventListener('input', () => {
                pitchValue.textContent = pitchSlider.value;
            });
        }
        
        // 开始语音加载流程
        function startVoiceLoading() {
            log('开始语音加载流程');
            
            // 显示加载状态
            voiceSelect.innerHTML = '<option value="">正在加载可用语音...</option>';
            voiceCount.textContent = '检测到 0 个可用语音';
            
            // 立即尝试加载一次
            loadVoices();
            
            // 监听语音变化事件
            if (synth.onvoiceschanged !== undefined) {
                log('设置语音变化事件监听器');
                synth.onvoiceschanged = () => {
                    log('检测到语音变化事件');
                    loadVoices();
                };
            }
            
            // 设置定时器，确保即使没有触发onvoiceschanged事件也能加载语音
            setTimeout(() => {
                if (voices.length === 0) {
                    log('定时器触发，再次尝试加载语音');
                    loadVoices();
                    
                    // 如果仍然没有语音，显示提示
                    if (voices.length === 0) {
                        log('多次尝试后仍未加载到语音');
                        voiceSelect.innerHTML = '<option value="">未检测到可用语音</option>';
                        supportStatus.innerHTML = `
                            <div class="flex items-center text-warning">
                                <i class="fa fa-exclamation-triangle mr-2 text-xl"></i>
                                <span>⚠️ 无法自动加载语音</span>
                            </div>
                            <p class="mt-2 text-gray-600">请尝试点击"刷新语音列表"按钮，或检查浏览器权限设置。</p>
                        `;
                    }
                }
            }, 3000);
        }
        
        // 加载可用语音
        function loadVoices() {
            log('开始加载语音...');
            
            // 获取语音列表
            const availableVoices = synth.getVoices();
            log(`从synth.getVoices()获取到 ${availableVoices.length} 个语音`);
            
            // 更新全局变量
            voices = availableVoices;
            
            // 清空选择框
            voiceSelect.innerHTML = '';
            
            // 更新语音计数
            voiceCount.textContent = `检测到 ${voices.length} 个可用语音`;
            
            // 如果没有语音，显示提示
            if (voices.length === 0) {
                log('未检测到可用语音');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '未检测到可用语音';
                voiceSelect.appendChild(option);
                return;
            }
            
            // 记录详细的语音信息
            log('检测到的语音详情:');
            voices.forEach((voice, index) => {
                log(`  ${index + 1}. ${voice.name} (${voice.lang}) - 本地: ${voice.localService}, 默认: ${voice.default}`);
            });
            
            // 按语言分组
            const voicesByLang = {};
            voices.forEach(voice => {
                if (!voicesByLang[voice.lang]) {
                    voicesByLang[voice.lang] = [];
                }
                voicesByLang[voice.lang].push(voice);
            });
            
            log('按语言分组:', Object.keys(voicesByLang));
            
            // 优先显示中文语音
            if (voicesByLang['zh-CN'] || voicesByLang['zh-TW'] || voicesByLang['zh']) {
                log('找到中文语音');
                addVoicesToSelect(voicesByLang, ['zh-CN', 'zh-TW', 'zh'], '中文');
            }
            
            // 添加其他语言
            Object.keys(voicesByLang).forEach(lang => {
                if (!lang.startsWith('zh')) {
                    const langName = getLanguageName(lang);
                    addVoicesToSelect(voicesByLang, [lang], langName);
                }
            });
            
            // 默认选择第一个语音
            if (voiceSelect.options.length > 0) {
                voiceSelect.options[0].selected = true;
                const firstVoice = voices.find(v => v.name === voiceSelect.options[0].value);
                if (firstVoice) {
                    displayVoiceDetails(firstVoice);
                }
                log('默认选择语音:', voiceSelect.options[0].text);
            }
            
            log('语音加载完成');
        }
        
        // 将语音添加到选择框
        function addVoicesToSelect(voicesByLang, langs, label) {
            log(`添加${label}语音组`);
            
            const optgroup = document.createElement('optgroup');
            optgroup.label = label;
            
            langs.forEach(lang => {
                if (voicesByLang[lang]) {
                    log(`添加${lang}语言的${voicesByLang[lang].length}个语音`);
                    
                    voicesByLang[lang].forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        
                        // 添加更详细的语音信息
                        const gender = getVoiceGender(voice);
                        const isLocal = voice.localService ? '本地' : '在线';
                        const isDefault = voice.default ? ' (默认)' : '';
                        
                        option.textContent = `${voice.name} (${gender}, ${isLocal})${isDefault}`;
                        
                        // 添加语音的详细信息作为title属性
                        option.title = `${voice.lang} - ${isLocal}语音${isDefault}`;
                        
                        optgroup.appendChild(option);
                    });
                }
            });
            
            if (optgroup.children.length > 0) {
                voiceSelect.appendChild(optgroup);
                log(`成功添加${optgroup.children.length}个${label}语音选项`);
            }
        }
        
        // 获取语言名称
        function getLanguageName(code) {
            const languages = {
                'en-US': '英语(美国)',
                'en-GB': '英语(英国)',
                'ja-JP': '日语',
                'ko-KR': '韩语',
                'fr-FR': '法语',
                'de-DE': '德语',
                'es-ES': '西班牙语',
                'ru-RU': '俄语',
                'ar-SA': '阿拉伯语',
                'hi-IN': '印地语'
            };
            return languages[code] || code;
        }
        
        // 获取语音性别
        function getVoiceGender(voice) {
            // 首先检查voice对象是否有gender属性
            if (voice.gender) {
                switch (voice.gender) {
                    case 'female':
                        return '女声';
                    case 'male':
                        return '男声';
                    default:
                        return '中性';
                }
            }
            
            // 如果没有gender属性，通过名称推断
            const name = voice.name.toLowerCase();
            
            // 女声关键词
            const femaleKeywords = ['female', 'woman', 'girl', 'tingting', 'yaoyao', 'lily', 'lucy', 'mary', 'sarah', 'jane'];
            // 男声关键词
            const maleKeywords = ['male', 'man', 'boy', 'zhiwei', 'daming', 'tom', 'john', 'mike', 'david', 'jack'];
            
            if (femaleKeywords.some(keyword => name.includes(keyword))) {
                return '女声';
            } else if (maleKeywords.some(keyword => name.includes(keyword))) {
                return '男声';
            }
            
            return '未知';
        }
        
        // 显示语音详细信息
        function displayVoiceDetails(voice) {
            const gender = getVoiceGender(voice);
            const isLocal = voice.localService ? '是' : '否';
            const isDefault = voice.default ? '是' : '否';
            
            voiceDetails.innerHTML = `
                <div class="space-y-2">
                    <p><strong>名称:</strong> ${voice.name}</p>
                    <p><strong>语言:</strong> ${voice.lang}</p>
                    <p><strong>性别:</strong> ${gender}</p>
                    <p><strong>本地语音:</strong> ${isLocal}</p>
                    <p><strong>默认语音:</strong> ${isDefault}</p>
                    <p><strong>URI:</strong> ${voice.voiceURI || 'N/A'}</p>
                </div>
            `;
        }
        
        // 测试选中的语音
        function testSelectedVoice() {
            const selectedVoice = voiceSelect.value;
            const text = testText.value.trim();
            
            if (!selectedVoice) {
                alert('请先选择一个语音');
                return;
            }
            
            if (!text) {
                alert('请输入测试文本');
                return;
            }
            
            if (isSpeaking) {
                synth.cancel();
                isSpeaking = false;
                testBtn.innerHTML = '<i class="fa fa-play mr-2"></i>播放测试语音';
                return;
            }
            
            log(`开始测试语音: ${selectedVoice}`);
            log(`测试文本: "${text}"`);
            log(`语速: ${rateSlider.value}, 音调: ${pitchSlider.value}`);
            
            // 找到选中的语音
            const voice = voices.find(v => v.name === selectedVoice);
            if (!voice) {
                alert('未找到选中的语音');
                return;
            }
            
            // 创建语音合成实例
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voice;
            utterance.rate = parseFloat(rateSlider.value);
            utterance.pitch = parseFloat(pitchSlider.value);
            utterance.volume = 1;
            
            // 设置事件处理
            utterance.onstart = () => {
                isSpeaking = true;
                testBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>停止播放';
                log('语音播放开始');
            };
            
            utterance.onend = () => {
                isSpeaking = false;
                testBtn.innerHTML = '<i class="fa fa-play mr-2"></i>播放测试语音';
                log('语音播放结束');
            };
            
            utterance.onerror = (event) => {
                isSpeaking = false;
                testBtn.innerHTML = '<i class="fa fa-play mr-2"></i>播放测试语音';
                log(`语音播放错误: ${event.error}`);
                alert(`播放出错: ${event.error}`);
            };
            
            // 开始播放
            synth.speak(utterance);
        }
        
        // 日志函数
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.className = 'mb-1';
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            
            debugInfo.appendChild(logEntry);
            debugInfo.scrollTop = debugInfo.scrollHeight;
            
            // 限制日志条目数量
            if (debugInfo.children.length > 100) {
                debugInfo.removeChild(debugInfo.firstChild);
            }
            
            console.log(`[语音测试] ${message}`);
        }
    </script>
</body>
</html>